<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Residual hooks and collection methods — collectResiduals • MAST</title><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="Residual hooks and collection methods — collectResiduals"><meta property="og:description" content="After each gene is fit, a hook function can optionally be run and the output saved.
This allows extended computations to be done using the fitted model, without keeping it in memory.
Here this is used to calculate various residuals, though in some cases they can be done using only the information contained in the ZlmFit-class."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">
    

    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">MAST</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.21.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li>
      <a href="../articles/MAITAnalysis.html">Using MAST with RNASeq: MAIT Analysis.</a>
    </li>
    <li>
      <a href="../articles/MAST-Intro.html">MAST Intro</a>
    </li>
    <li>
      <a href="../articles/MAST-interoperability.html">Interoptability between MAST and SingleCellExperiment-derived packages.</a>
    </li>
  </ul></li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/RGLab/MAST/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Residual hooks and collection methods</h1>
    <small class="dont-index">Source: <a href="https://github.com/RGLab/MAST/blob/HEAD/R/zlmHooks.R" class="external-link"><code>R/zlmHooks.R</code></a></small>
    <div class="hidden name"><code>collectResiduals.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>After each gene is fit, a hook function can optionally be run and the output saved.
This allows extended computations to be done using the fitted model, without keeping it in memory.
Here this is used to calculate various residuals, though in some cases they can be done using only the information contained in the <code>ZlmFit</code>-class.</p>
    </div>

    <div id="ref-usage">
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="fu">collectResiduals</span><span class="op">(</span><span class="va">x</span>, <span class="va">sca</span>, newLayerName <span class="op">=</span> <span class="st">"Residuals"</span><span class="op">)</span>

<span class="fu">discrete_residuals_hook</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>

<span class="fu">continuous_residuals_hook</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>

<span class="fu">combined_residuals_hook</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>

<span class="fu">deviance_residuals_hook</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>

<span class="fu">fitted_phat</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>

<span class="fu">partialScore</span><span class="op">(</span><span class="va">x</span>, <span class="va">effectRegex</span><span class="op">)</span></code></pre></div>
    </div>

    <div id="arguments">
    <h2>Arguments</h2>
    <dl><dt>x</dt>
<dd><p><code>ZlmFit</code>-class</p></dd>
<dt>sca</dt>
<dd><p><code>SingleCellAssay</code> object to which the residuals should be added</p></dd>
<dt>newLayerName</dt>
<dd><p><code>character</code> name of the assay layer</p></dd>
<dt>effectRegex</dt>
<dd><p>a regular expression naming columns of the design corresponding to \(Z_0\).
Generally these should be the treatment effects of interest.</p></dd>
</dl></div>
    <div id="value">
    <h2>Value</h2>
    <p>copy of <code>sca</code> with new layer</p>
    </div>
    <div id="functions">
    <h2>Functions</h2>
    
<ul><li><p><code>discrete_residuals_hook</code>: Hook to get the discrete residuals, ie, difference between expected probability of expression and observed</p></li>
<li><p><code>continuous_residuals_hook</code>: Hook to get the continuous residuals, ie, residuals for conditionally positive observations.  If an observation is zero, it's residual is defined to be zero as well.</p></li>
<li><p><code>combined_residuals_hook</code>: Hook to get the combined residuals, ie, Y-E(U)*E(V)</p></li>
<li><p><code>deviance_residuals_hook</code>: Standardized deviance residuals hook. Computes the sum of the standardized deviance residuals for the discrete and continuous models (scaled to have unit variance).  If the observation is zero then only the discrete component is used.</p></li>
<li><p><code>fitted_phat</code>: Hook to return p_hat, the predicted probability of expression.</p></li>
<li><p><code>partialScore</code>: Compute \(Y_i-E(V_i|X_i, Z_0)E(U|X_i, Z_0)\), where \(Z_0\) is a  treatment effect (being left in) and \(X_i\) is a nuisance effect (being regressed out).</p></li>
</ul></div>
    <div id="total-residual-types">
    <h2>Total residual types</h2>
    

<p>Each component of the model contributes several flavors of residual, which can be combined in various fashions.
The discrete residual can be on the response scale (thus subtracting the predicted probability of expression from the 0/1 expression value).
Or it can be a deviance residual, revealing something about the log-likelihood.</p>
    </div>
    <div id="partial-residuals">
    <h2>Partial residuals</h2>
    

<p>It's also possible to consider partial residuals, in which the contribution of a particular covariate is added back into the model.</p>
    </div>
    <div id="see-also">
    <h2>See also</h2>
    <div class="dont-index"><p>zlm</p></div>
    </div>

    <div id="ref-examples">
    <h2>Examples</h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">vbetaFA</span><span class="op">)</span></span>
<span class="r-in"><span class="va">svbeta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">vbetaFA</span>, <span class="va">ncells</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span></span>
<span class="r-in"><span class="va">svbeta</span> <span class="op">&lt;-</span> <span class="va">svbeta</span><span class="op">[</span><span class="fu"><a href="freq.html">freq</a></span><span class="op">(</span><span class="va">svbeta</span><span class="op">)</span><span class="op">&gt;</span><span class="fl">.4</span>,<span class="op">]</span></span>
<span class="r-in"><span class="va">window</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x1</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu">assays</span><span class="op">(</span><span class="va">x1</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x2</span><span class="op">)</span> <span class="va">x2</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">]</span><span class="op">)</span></span>
<span class="r-in"><span class="co">#total residuals of the response</span></span>
<span class="r-in"><span class="va">z1</span> <span class="op">&lt;-</span> <span class="fu"><a href="zlm.html">zlm</a></span><span class="op">(</span><span class="op">~</span> <span class="va">Stim.Condition</span>, <span class="va">svbeta</span>, hook<span class="op">=</span><span class="va">discrete_residuals_hook</span><span class="op">)</span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Done!</span>
<span class="r-in"><span class="fu"><a href="https://rdrr.io/r/stats/window.html" class="external-link">window</a></span><span class="op">(</span><span class="fu">collectResiduals</span><span class="op">(</span><span class="va">z1</span>, <span class="va">svbeta</span><span class="op">)</span><span class="op">)</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $Et</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         wellKey</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> primerid Sub01 1 A01 Sub01 1 A02 Sub01 1 A03 Sub01 1 A04 Sub01 1 A05</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     CCR7     0.00000    18.32835    18.72408     0.00000     0.00000</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     CD28    14.36047     0.00000    16.50232    15.36025    13.85367</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     CD3d    14.39789    15.71954    17.08992    16.37704    17.38282</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         wellKey</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> primerid Sub01 1 A06</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     CCR7     0.00000</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     CD28     0.00000</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     CD3d    15.54438</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $Residuals</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      Sub01 1 A01 Sub01 1 A02 Sub01 1 A03 Sub01 1 A04 Sub01 1 A05 Sub01 1 A06</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> CCR7  -0.5009035   0.4990965   0.4990965  -0.5009035  -0.5009035  -0.5009035</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> CD28   0.4962616  -0.5037384   0.4962616   0.4962616   0.4962616  -0.5037384</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> CD3d   0.3473145   0.3473145   0.3473145   0.3473145   0.3473145   0.3473145</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-in"><span class="va">z2</span> <span class="op">&lt;-</span> <span class="fu"><a href="zlm.html">zlm</a></span><span class="op">(</span><span class="op">~</span> <span class="va">Stim.Condition</span>, <span class="va">svbeta</span>, hook<span class="op">=</span><span class="va">continuous_residuals_hook</span><span class="op">)</span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Done!</span>
<span class="r-in"><span class="fu"><a href="https://rdrr.io/r/stats/window.html" class="external-link">window</a></span><span class="op">(</span><span class="fu">collectResiduals</span><span class="op">(</span><span class="va">z2</span>, <span class="va">svbeta</span><span class="op">)</span><span class="op">)</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $Et</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         wellKey</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> primerid Sub01 1 A01 Sub01 1 A02 Sub01 1 A03 Sub01 1 A04 Sub01 1 A05</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     CCR7     0.00000    18.32835    18.72408     0.00000     0.00000</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     CD28    14.36047     0.00000    16.50232    15.36025    13.85367</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     CD3d    14.39789    15.71954    17.08992    16.37704    17.38282</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         wellKey</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> primerid Sub01 1 A06</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     CCR7     0.00000</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     CD28     0.00000</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     CD3d    15.54438</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $Residuals</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      Sub01 1 A01 Sub01 1 A02 Sub01 1 A03 Sub01 1 A04 Sub01 1 A05 Sub01 1 A06</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> CCR7    0.000000   0.1679555   0.5636873   0.0000000   0.0000000    0.000000</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> CD28   -1.338277   0.0000000   0.8035785  -0.3384889  -1.8450766    0.000000</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> CD3d   -2.235474  -0.9138159   0.4565626  -0.2563244   0.7494639   -1.088981</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-in"><span class="va">z3</span> <span class="op">&lt;-</span> <span class="fu"><a href="zlm.html">zlm</a></span><span class="op">(</span><span class="op">~</span> <span class="va">Stim.Condition</span>, <span class="va">svbeta</span>, hook<span class="op">=</span><span class="va">combined_residuals_hook</span><span class="op">)</span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Done!</span>
<span class="r-in"><span class="fu"><a href="https://rdrr.io/r/stats/window.html" class="external-link">window</a></span><span class="op">(</span><span class="fu">collectResiduals</span><span class="op">(</span><span class="va">z3</span>, <span class="va">svbeta</span><span class="op">)</span><span class="op">)</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $Et</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         wellKey</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> primerid Sub01 1 A01 Sub01 1 A02 Sub01 1 A03 Sub01 1 A04 Sub01 1 A05</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     CCR7     0.00000    18.32835    18.72408     0.00000     0.00000</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     CD28    14.36047     0.00000    16.50232    15.36025    13.85367</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     CD3d    14.39789    15.71954    17.08992    16.37704    17.38282</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>         wellKey</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> primerid Sub01 1 A06</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     CCR7     0.00000</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     CD28     0.00000</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     CD3d    15.54438</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> $Residuals</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      Sub01 1 A01 Sub01 1 A02 Sub01 1 A03 Sub01 1 A04 Sub01 1 A05 Sub01 1 A06</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> CCR7   -9.096604    9.231742    9.627474   -9.096604   -9.096604   -9.096604</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> CD28    6.452407   -7.908060    8.594263    7.452195    5.945608   -7.908060</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> CD3d    3.541534    4.863192    6.233570    5.520683    6.526472    4.688027</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> </span>
<span class="r-in"><span class="co">#partial residuals</span></span>
<span class="r-in"><span class="fu">colData</span><span class="op">(</span><span class="va">svbeta</span><span class="op">)</span><span class="op">$</span><span class="va">ngeneson</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="fu">assay</span><span class="op">(</span><span class="va">svbeta</span><span class="op">)</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span></span>
<span class="r-in"><span class="va">z5</span> <span class="op">&lt;-</span> <span class="fu"><a href="zlm.html">zlm</a></span><span class="op">(</span><span class="op">~</span> <span class="va">Stim.Condition</span> <span class="op">+</span> <span class="va">ngeneson</span>, <span class="va">svbeta</span><span class="op">)</span></span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> </span>
<span class="r-msg co"><span class="r-pr">#&gt;</span> Done!</span>
<span class="r-in"><span class="fu">partialScore</span><span class="op">(</span><span class="va">z5</span>, <span class="st">'Stim.Condition'</span><span class="op">)</span></span>
</code></pre></div>
    </div>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by Andrew McDavid, Greg Finak, Masanao Yajima.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.</p>
</div>

      </footer></div>

  


  

  </body></html>

