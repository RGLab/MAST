<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Using MAST with RNASeq: MAIT Analysis. • MAST</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Using MAST with RNASeq: MAIT Analysis.">
<meta property="og:description" content="MAST">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">MAST</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.21.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/MAITAnalysis.html">Using MAST with RNASeq: MAIT Analysis.</a>
    </li>
    <li>
      <a href="../articles/MAST-Intro.html">MAST Intro</a>
    </li>
    <li>
      <a href="../articles/MAST-interoperability.html">Interoptability between MAST and SingleCellExperiment-derived packages.</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/RGLab/MAST/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="MAITAnalysis_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Using MAST with RNASeq: MAIT Analysis.</h1>
                        <h4 data-toc-skip class="author">Greg Finak</h4>
                        <h4 data-toc-skip class="author">Andrew McDavid</h4>
                        <h4 data-toc-skip class="author">Masanao Yajima</h4>
                        <h4 data-toc-skip class="author">Jingyuan Deng</h4>
                        <h4 data-toc-skip class="author">Vivian Gersuk</h4>
                        <h4 data-toc-skip class="author">Alex Shalek</h4>
                        <h4 data-toc-skip class="author">Chloe K. Schlicter</h4>
                        <h4 data-toc-skip class="author">Hannah W. Miller</h4>
                        <h4 data-toc-skip class="author">M. Juliana McElrath</h4>
                        <h4 data-toc-skip class="author">Martin Prlic</h4>
                        <h4 data-toc-skip class="author">Peter Linsley</h4>
                        <h4 data-toc-skip class="author">Raphael Gottardo</h4>
            
            <h4 data-toc-skip class="date">2022-02-01</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/RGLab/MAST/blob/HEAD/vignettes/MAITAnalysis.Rmd" class="external-link"><code>vignettes/MAITAnalysis.Rmd</code></a></small>
      <div class="hidden name"><code>MAITAnalysis.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>We will learn how to use the package <a href="http://genomebiology.biomedcentral.com/articles/10.1186/s13059-015-0844-5" class="external-link">MAST</a> to analyze single cell RNAseq experiments.</p>
<p>Starting from a matrix of counts of transcripts (cells by transcripts), we will discuss the preliminary steps of quality control, filtering, and exploratory data analysis. Once we are satisfied that we have high-quality expression, we will consider tests for differential expression and ways to visualize results. It is often helpful to synthesize from gene-level into module-level statements. Therefore, we will learn how to use MAST to test for gene set enrichment.</p>
<p>We will apply these methods to a data set of Mucosal Associated Invariant T cells (MAITs), measured on the Fluidigm C1. Half of the cells have been cytokine stimulated.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span>
    <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggobi.github.io/ggally/" class="external-link">GGally</a></span><span class="op">)</span>
    <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">GSEABase</span><span class="op">)</span>
    <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://bioinf.wehi.edu.au/limma" class="external-link">limma</a></span><span class="op">)</span>
    <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/hadley/reshape" class="external-link">reshape2</a></span><span class="op">)</span>
    <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span>
    <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://yihui.org/knitr/" class="external-link">knitr</a></span><span class="op">)</span>
    <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">TxDb.Hsapiens.UCSC.hg19.knownGene</span><span class="op">)</span>
    <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://stringr.tidyverse.org" class="external-link">stringr</a></span><span class="op">)</span>
    <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://renozao.github.io/NMF" class="external-link">NMF</a></span><span class="op">)</span>
    <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/erichson/rSVD" class="external-link">rsvd</a></span><span class="op">)</span>
    <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">RColorBrewer</span><span class="op">)</span>
    <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RGLab/MAST/" class="external-link">MAST</a></span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>
<span class="co">#options(mc.cores = detectCores() - 1) #if you have multiple cores to spin</span>
<span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>mc.cores <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
<span class="fu">knitr</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/knitr/man/opts_chunk.html" class="external-link">opts_chunk</a></span><span class="op">$</span><span class="fu">set</span><span class="op">(</span>message <span class="op">=</span> <span class="cn">FALSE</span>,error <span class="op">=</span> <span class="cn">FALSE</span>,warning <span class="op">=</span> <span class="cn">FALSE</span>,cache <span class="op">=</span> <span class="cn">FALSE</span>,fig.width<span class="op">=</span><span class="fl">8</span>,fig.height<span class="op">=</span><span class="fl">6</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="loading-and-transforming-data">Loading and transforming data<a class="anchor" aria-label="anchor" href="#loading-and-transforming-data"></a>
</h2>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">freq_expressed</span> <span class="op">&lt;-</span> <span class="fl">0.2</span>
<span class="va">FCTHRESHOLD</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log2</a></span><span class="op">(</span><span class="fl">1.5</span><span class="op">)</span></code></pre></div>
<p>First, let’s set some constants that we can use throughout this analysis.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">maits</span>, package<span class="op">=</span><span class="st">'MAST'</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">maits</span><span class="op">$</span><span class="va">expressionmat</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">maits</span><span class="op">$</span><span class="va">cdat</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">maits</span><span class="op">$</span><span class="va">fdat</span><span class="op">)</span></code></pre></div>
<p>Next, let’s load the data, which consists of a matrix of log2 + 1 transcripts per million (TPM), as output by RSEM. Internally, we use the packages <a href="https://github.com/RGLab/RNASeqPipelineR" class="external-link">RNASeqPipelineR</a> and <a href="https://github.com/RGLab/preProcessData" class="external-link">preprocessData</a> to facilitate aligning and quantitating the raw reads. This is an experiment on Mucosal Associated Invariant T-cells from a single healthy donor. A number of cells were subjected to reverse transcription and library prep immediately, while others were first stimulated for 24 hours with a cytokine cocktail.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">scaRaw</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/FromMatrix.html">FromMatrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">maits</span><span class="op">$</span><span class="va">expressionmat</span><span class="op">)</span>, <span class="va">maits</span><span class="op">$</span><span class="va">cdat</span>, <span class="va">maits</span><span class="op">$</span><span class="va">fdat</span><span class="op">)</span></code></pre></div>
<p><code>FromMatrix</code> constructs an object from a matrix (genes <span class="math inline">\(\times\)</span> cells) of expression, a <code>data.frame</code> of cell-level covariance and a <code>data.frame</code> of feature-level covariates. In this case, there are 96 single cells measured over 16302 genes. We derive from the <code>SummarizedExperiment</code> class, which makes it easy for feature (row) and cell (column) metadata to come along for the ride. There is also a constructor, <code>FromFlatDF</code> for flattened data where measurements, and cell and feature covariates are intermingled.</p>
<div class="section level3">
<h3 id="exploratory-data-analysis">Exploratory Data Analysis<a class="anchor" aria-label="anchor" href="#exploratory-data-analysis"></a>
</h3>
<p>Let’s explore these data with a heatmap and some PCA.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/NMF/man/aheatmap.html" class="external-link">aheatmap</a></span><span class="op">(</span><span class="fu">assay</span><span class="op">(</span><span class="va">scaRaw</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">1000</span>,<span class="op">]</span><span class="op">)</span>, labRow<span class="op">=</span><span class="st">''</span>, annCol<span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu">colData</span><span class="op">(</span><span class="va">scaRaw</span><span class="op">)</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'condition'</span>, <span class="st">'ourfilter'</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, distfun<span class="op">=</span><span class="st">'spearman'</span><span class="op">)</span></code></pre></div>
<p><img src="MAITAnalysis_files/figure-html/heatmap-1.png" width="576"></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span>
<span class="va">plotPCA</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sca_obj</span><span class="op">)</span><span class="op">{</span>
    <span class="va">projection</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/rsvd/man/rpca.html" class="external-link">rpca</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu">assay</span><span class="op">(</span><span class="va">sca_obj</span><span class="op">)</span><span class="op">)</span>, retx<span class="op">=</span><span class="cn">TRUE</span>, k<span class="op">=</span><span class="fl">4</span><span class="op">)</span><span class="op">$</span><span class="va">x</span>
    <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">projection</span><span class="op">)</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"PC1"</span>,<span class="st">"PC2"</span>,<span class="st">"PC3"</span>,<span class="st">"PC4"</span><span class="op">)</span>
    <span class="va">pca</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span><span class="va">projection</span>,  <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu">colData</span><span class="op">(</span><span class="va">sca_obj</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://ggobi.github.io/ggally/reference/ggpairs.html" class="external-link">ggpairs</a></span><span class="op">(</span><span class="va">pca</span>, columns<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'PC1'</span>, <span class="st">'PC2'</span>, <span class="st">'PC3'</span>, <span class="st">'libSize'</span>, <span class="st">'PercentToHuman'</span>, <span class="st">'nGeneOn'</span>, <span class="st">'exonRate'</span><span class="op">)</span>,
            mapping<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color<span class="op">=</span><span class="va">condition</span><span class="op">)</span>, upper<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>continuous<span class="op">=</span><span class="st">'blank'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="va">pca</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/plotPCA.html" class="external-link">plotPCA</a></span><span class="op">(</span><span class="va">scaRaw</span><span class="op">)</span></code></pre></div>
<p><img src="MAITAnalysis_files/figure-html/pca-1.png" width="576"></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">filterCrit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="fu">colData</span><span class="op">(</span><span class="va">scaRaw</span><span class="op">)</span>, <span class="va">pastFastqc</span><span class="op">==</span><span class="st">"PASS"</span><span class="op">&amp;</span> <span class="va">exonRate</span> <span class="op">&gt;</span><span class="fl">0.3</span> <span class="op">&amp;</span> <span class="va">PercentToHuman</span><span class="op">&gt;</span><span class="fl">0.6</span> <span class="op">&amp;</span> <span class="va">nGeneOn</span><span class="op">&gt;</span> <span class="fl">4000</span><span class="op">)</span></code></pre></div>
<p>From the PCA and heatmap we can tell that we’ve got some data quality issues with low-diversity libraries, and libraries where we capture a lot of non mRNA. We’ll set a filtering threshold using the <a href="https://en.wikipedia.org/wiki/I_know_it_when_I_see_it" class="external-link">Potter Stewart</a> method, though Shalek et al and others have come up with more principled ways, such as training SVM on the expression data and quality metrics to predict failed libraries. Though this still presupposes a set of labeled “failures” and “successes”.</p>
</div>
<div class="section level3">
<h3 id="filtering">Filtering<a class="anchor" aria-label="anchor" href="#filtering"></a>
</h3>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sca</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/subset.data.table.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">scaRaw</span>,<span class="va">filterCrit</span><span class="op">)</span>
<span class="va">eid</span> <span class="op">&lt;-</span> <span class="fu">select</span><span class="op">(</span><span class="va">TxDb.Hsapiens.UCSC.hg19.knownGene</span>,keys <span class="op">=</span> <span class="fu">mcols</span><span class="op">(</span><span class="va">sca</span><span class="op">)</span><span class="op">$</span><span class="va">entrez</span>,keytype <span class="op">=</span><span class="st">"GENEID"</span>,columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"GENEID"</span>,<span class="st">"TXNAME"</span><span class="op">)</span><span class="op">)</span>
<span class="va">ueid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/duplicated.html" class="external-link">unique</a></span><span class="op">(</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/na.omit.data.table.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="va">eid</span><span class="op">)</span><span class="op">$</span><span class="va">GENEID</span><span class="op">)</span>
<span class="va">sca</span> <span class="op">&lt;-</span> <span class="va">sca</span><span class="op">[</span><span class="fu">mcols</span><span class="op">(</span><span class="va">sca</span><span class="op">)</span><span class="op">$</span><span class="va">entrez</span> <span class="op"><a href="https://rdrr.io/pkg/BiocGenerics/man/match.html" class="external-link">%in%</a></span> <span class="va">ueid</span>,<span class="op">]</span>
<span class="co">## Remove invariant genes</span>
<span class="va">sca</span> <span class="op">&lt;-</span> <span class="va">sca</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="../reference/freq.html">freq</a></span><span class="op">(</span><span class="va">sca</span><span class="op">)</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span>, <span class="fl">6000</span><span class="op">)</span>,<span class="op">]</span></code></pre></div>
<p>We’ll now consider only cells that pass the filter. <code>subset(scaRaw, filterCrit)</code> is just syntactic sugar for subsetting by columns, but who doesn’t like a little sugar? We’ll also limit ourselves to transcripts that have an EntrezGene id to facilitate interpretation. Lastly, we will take a subsample of about 50% of the total genes to keep this vignette from taking too long or too much memory.</p>
<div class="section level4">
<h4 id="recalculating-the-cellular-detection-rate-ngeneson">Recalculating the cellular detection rate (ngeneson)<a class="anchor" aria-label="anchor" href="#recalculating-the-cellular-detection-rate-ngeneson"></a>
</h4>
<p>We and others have found that the number of genes detected in a sample, which we deemed the cellular detection rate is often the first principal component. After we removed genes low expression, perhaps we want to recalculate it.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cdr2</span> <span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="fu">assay</span><span class="op">(</span><span class="va">sca</span><span class="op">)</span><span class="op">&gt;</span><span class="fl">0</span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/qplot.html" class="external-link">qplot</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">cdr2</span>, y<span class="op">=</span><span class="fu">colData</span><span class="op">(</span><span class="va">sca</span><span class="op">)</span><span class="op">$</span><span class="va">nGeneOn</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">'New CDR'</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">'Old CDR'</span><span class="op">)</span></code></pre></div>
<p><img src="MAITAnalysis_files/figure-html/unnamed-chunk-1-1.png" width="384"></p>
<p>We can assign this to a new column in the <code>colData</code> in the obvious fashion:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">colData</span><span class="op">(</span><span class="va">sca</span><span class="op">)</span><span class="op">$</span><span class="va">cngeneson</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">cdr2</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level4">
<h4 id="pca-on-filtered-cells">PCA on filtered cells<a class="anchor" aria-label="anchor" href="#pca-on-filtered-cells"></a>
</h4>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/plotPCA.html" class="external-link">plotPCA</a></span><span class="op">(</span><span class="va">sca</span><span class="op">)</span></code></pre></div>
<p><img src="MAITAnalysis_files/figure-html/pcaFilter-1.png" width="576"></p>
<p>PC1 now primarily captures stimulation effects. We still observe that PC2 correlates with the exonRate and ngeneson, but the data are more smoothly distributed.</p>
</div>
<div class="section level4">
<h4 id="exercises-on-loading-and-transforming-data">Exercises on loading and transforming data<a class="anchor" aria-label="anchor" href="#exercises-on-loading-and-transforming-data"></a>
</h4>
<ol style="list-style-type: decimal">
<li>These samples were reverse-transcribed and amplified on two Fluidigm C1 chips (and stimulation is completely confounded with chip…) The chip location is contained in the column <code>wellKey</code> in <code>colData(sca)</code> as a three-character string like <code>CXX</code>. How could you extract the chip location and add it as column to the cellular data? Hint: <code>str_split_fixed</code> or <code>str_extract</code> may be your friends here.</li>
</ol>
</div>
</div>
</div>
<div class="section level2">
<h2 id="adaptive-thresholding">Adaptive thresholding<a class="anchor" aria-label="anchor" href="#adaptive-thresholding"></a>
</h2>
<p>Single cell gene expression data are known to be zero-inflated and bimodal, which is feature we observe here as well.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">scaSample</span> <span class="op">&lt;-</span> <span class="va">sca</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="../reference/freq.html">freq</a></span><span class="op">(</span><span class="va">sca</span><span class="op">)</span><span class="op">&gt;</span><span class="fl">.1</span><span class="op">)</span>, <span class="fl">20</span><span class="op">)</span>,<span class="op">]</span>
<span class="va">flat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/methods/as.html" class="external-link">as</a></span><span class="op">(</span><span class="va">scaSample</span>, <span class="st">'data.table'</span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">flat</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">value</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">symbolid</span>, scale<span class="op">=</span><span class="st">'free_y'</span><span class="op">)</span></code></pre></div>
<p><img src="MAITAnalysis_files/figure-html/distribution-1.png" width="576"></p>
<p>Here we’ve taken subsample of size 20, then flattened it into a <code>data.table</code> to make it easy to plot with <code>ggplot2</code>.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">thres</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/thresholdSCRNACountMatrix.html">thresholdSCRNACountMatrix</a></span><span class="op">(</span><span class="fu">assay</span><span class="op">(</span><span class="va">sca</span><span class="op">)</span>, nbins <span class="op">=</span> <span class="fl">20</span>, min_per_bin <span class="op">=</span> <span class="fl">30</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>,<span class="fl">4</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">thres</span><span class="op">)</span></code></pre></div>
<p><img src="MAITAnalysis_files/figure-html/threshold-1.png" width="576"></p>
<p>We suspect that the left-most mode corresponds to non-specific hybridization of mRNA or genomic DNA. Here we apply an adaptive scheme to threshold values below a cut-off that depends on the intensity of the signal cluster from the gene (determined from the median expression value). When we plot the threshold vs genes binned by median expression value, we can see this evolution of thresholding value.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">assays</span><span class="op">(</span><span class="va">sca</span>, withDimnames <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>thresh<span class="op">=</span><span class="va">thres</span><span class="op">$</span><span class="va">counts_threshold</span>, tpm<span class="op">=</span><span class="fu">assay</span><span class="op">(</span><span class="va">sca</span><span class="op">)</span><span class="op">)</span>
<span class="va">expressed_genes</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/freq.html">freq</a></span><span class="op">(</span><span class="va">sca</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">freq_expressed</span>
<span class="va">sca</span> <span class="op">&lt;-</span> <span class="va">sca</span><span class="op">[</span><span class="va">expressed_genes</span>,<span class="op">]</span></code></pre></div>
<p>We’ll limit ourselves to genes that are found in at least 0.2 of the sample (since we won’t have any power to conclude much about less frequent transcripts). We will also downsample to 1000 genes to keep this vignette from running too slowly.</p>
<div class="section level4">
<h4 id="exercises-on-thresholding">Exercises on thresholding<a class="anchor" aria-label="anchor" href="#exercises-on-thresholding"></a>
</h4>
<ol start="2" style="list-style-type: decimal">
<li>Many modeling procedures assume (or perform best) when the data are Normally distributed. How could we evaluate how thresholding affects the Normality of the data? How about the Normality of the non-zero data?</li>
</ol>
</div>
</div>
<div class="section level2">
<h2 id="differential-expression-using-a-hurdle-model">Differential Expression using a Hurdle model<a class="anchor" aria-label="anchor" href="#differential-expression-using-a-hurdle-model"></a>
</h2>
<p>We’ll fit a hurdle model, modeling the condition and (centered) <code>ngeneson</code> factor, thus adjusting for the cellular detection rate.</p>
<p>In order to have more interpretable coefficients, we’ll set the reference level of the factor to be the “unstimulated” cells.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cond</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu">colData</span><span class="op">(</span><span class="va">sca</span><span class="op">)</span><span class="op">$</span><span class="va">condition</span><span class="op">)</span>
<span class="va">cond</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/stats/relevel.html" class="external-link">relevel</a></span><span class="op">(</span><span class="va">cond</span>,<span class="st">"Unstim"</span><span class="op">)</span>
<span class="fu">colData</span><span class="op">(</span><span class="va">sca</span><span class="op">)</span><span class="op">$</span><span class="va">condition</span><span class="op">&lt;-</span><span class="va">cond</span>
<span class="va">zlmCond</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/zlm.html">zlm</a></span><span class="op">(</span><span class="op">~</span><span class="va">condition</span> <span class="op">+</span> <span class="va">cngeneson</span>, <span class="va">sca</span><span class="op">)</span>
<span class="co"># The following are equivalent</span>
<span class="co">## lrt &lt;- lrTest(zlm, "condition")</span>
<span class="co">## lrt &lt;- lrTest(zlm, CoefficientHypothesis('conditionStim'))</span>

<span class="co"># This would test if 2*cngeneson=conditionStim</span>
<span class="co">#  This is sheer nonsense biologically and statistically, but gives an example of the flexibility.</span>
<span class="co">## lrt &lt;- lrTest(zlm, Hypothesis('2*cngeneson-conditionStim'))</span></code></pre></div>
<p>We could run a likelihood ratio test here, testing for differences when we drop the <code>condition</code> factor. Note that any arbitrary contrast matrix can be tested here, and specified either using a matrix or syntactically. See <code>Hypothesis</code> for details.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#only test the condition coefficient.</span>
<span class="va">summaryCond</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/NMF/man/assess.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">zlmCond</span>, doLRT<span class="op">=</span><span class="st">'conditionStim'</span><span class="op">)</span> 
<span class="co">#print the top 4 genes by contrast using the logFC</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">summaryCond</span>, n<span class="op">=</span><span class="fl">4</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## Fitted zlm with top 4 genes per contrast:</span>
<span class="co">## ( log fold change Z-score )</span>
<span class="co">##  primerid conditionStim cngeneson</span>
<span class="co">##  1831       -6.8*          2.7   </span>
<span class="co">##  1843       -8.2*          0.5   </span>
<span class="co">##  2353       -7.7*          0.4   </span>
<span class="co">##  255252     -5.6           3.8*  </span>
<span class="co">##  392490     -1.1          -3.8*  </span>
<span class="co">##  7295        7.5*          0.4   </span>
<span class="co">##  80270      -5.6           3.8*  </span>
<span class="co">##  9360       -2.4           3.8*</span></code></pre>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## by discrete Z-score</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">summaryCond</span>, n<span class="op">=</span><span class="fl">4</span>, by<span class="op">=</span><span class="st">'D'</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## Fitted zlm with top 4 genes per contrast:</span>
<span class="co">## ( Wald Z-scores on discrete )</span>
<span class="co">##  primerid  conditionStim cngeneson</span>
<span class="co">##  100132356   -3.9*          2.1   </span>
<span class="co">##  1831        -4.1*          1.1   </span>
<span class="co">##  1843        -4.0*          0.1   </span>
<span class="co">##  5465        -3.2           4.5*  </span>
<span class="co">##  55142       -3.1           4.2*  </span>
<span class="co">##  558         -4.1*          3.7   </span>
<span class="co">##  56996       -3.8           4.7*  </span>
<span class="co">##  6360        -3.0           4.3*</span></code></pre>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## by continuous Z-score</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">summaryCond</span>, n<span class="op">=</span><span class="fl">4</span>, by<span class="op">=</span><span class="st">'C'</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## Fitted zlm with top 4 genes per contrast:</span>
<span class="co">## ( Wald Z-scores tests on continuous )</span>
<span class="co">##  primerid conditionStim cngeneson</span>
<span class="co">##  3002        5.9*          0.4   </span>
<span class="co">##  51188       1.7          -4.1*  </span>
<span class="co">##  54900       2.3          -4.2*  </span>
<span class="co">##  54964       2.1          -4.2*  </span>
<span class="co">##  6164       -5.1*          0.8   </span>
<span class="co">##  6232       -6.0*         -0.7   </span>
<span class="co">##  7295        5.7*         -1.1   </span>
<span class="co">##  9459        3.4          -4.0*</span></code></pre>
<p>But often of more general use is this delicious syntactic sugar to make a giant <code>data.table</code> containing coefficients, standard errors, etc, for the various model components. Many Bothan spies died so that we could pretty-print this summary of the top differentially expressed genes.</p>
<p>Strip off the <code>$datatable</code> component to stop this pretty-printing (or call <code>print.default</code>.)</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">summaryDt</span> <span class="op">&lt;-</span> <span class="va">summaryCond</span><span class="op">$</span><span class="va">datatable</span>
<span class="va">fcHurdle</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">summaryDt</span><span class="op">[</span><span class="va">contrast</span><span class="op">==</span><span class="st">'conditionStim'</span> <span class="op">&amp;</span> <span class="va">component</span><span class="op">==</span><span class="st">'H'</span>,<span class="fu">.</span><span class="op">(</span><span class="va">primerid</span>, <span class="va">`Pr(&gt;Chisq)`</span><span class="op">)</span><span class="op">]</span>, <span class="co">#hurdle P values</span>
                      <span class="va">summaryDt</span><span class="op">[</span><span class="va">contrast</span><span class="op">==</span><span class="st">'conditionStim'</span> <span class="op">&amp;</span> <span class="va">component</span><span class="op">==</span><span class="st">'logFC'</span>, <span class="fu">.</span><span class="op">(</span><span class="va">primerid</span>, <span class="va">coef</span>, <span class="va">ci.hi</span>, <span class="va">ci.lo</span><span class="op">)</span><span class="op">]</span>, by<span class="op">=</span><span class="st">'primerid'</span><span class="op">)</span> <span class="co">#logFC coefficients</span>

<span class="va">fcHurdle</span><span class="op">[</span>,<span class="va">fdr</span><span class="op">:=</span><span class="fu"><a href="https://rdrr.io/r/stats/p.adjust.html" class="external-link">p.adjust</a></span><span class="op">(</span><span class="va">`Pr(&gt;Chisq)`</span>, <span class="st">'fdr'</span><span class="op">)</span><span class="op">]</span>
<span class="va">fcHurdleSig</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">fcHurdle</span><span class="op">[</span><span class="va">fdr</span><span class="op">&lt;</span><span class="fl">.05</span> <span class="op">&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">coef</span><span class="op">)</span><span class="op">&gt;</span><span class="va">FCTHRESHOLD</span><span class="op">]</span>, <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="fu">mcols</span><span class="op">(</span><span class="va">sca</span><span class="op">)</span><span class="op">)</span>, by<span class="op">=</span><span class="st">'primerid'</span><span class="op">)</span>
<span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setorder.html" class="external-link">setorder</a></span><span class="op">(</span><span class="va">fcHurdleSig</span>, <span class="va">fdr</span><span class="op">)</span></code></pre></div>
<p>We see that there are 230 genes significant at a FDR of 5% and with a log-fold change larger than 0.6.</p>
<div class="section level4">
<h4 id="visualization-of-50-most-differentially-expressed-genes">Visualization of 50 most differentially expressed genes<a class="anchor" aria-label="anchor" href="#visualization-of-50-most-differentially-expressed-genes"></a>
</h4>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">entrez_to_plot</span> <span class="op">&lt;-</span> <span class="va">fcHurdleSig</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">50</span>,<span class="va">primerid</span><span class="op">]</span>
<span class="va">symbols_to_plot</span> <span class="op">&lt;-</span> <span class="va">fcHurdleSig</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">50</span>,<span class="va">symbolid</span><span class="op">]</span>
<span class="va">flat_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/methods/as.html" class="external-link">as</a></span><span class="op">(</span><span class="va">sca</span><span class="op">[</span><span class="va">entrez_to_plot</span>,<span class="op">]</span>, <span class="st">'data.table'</span><span class="op">)</span>
<span class="va">ggbase</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">flat_dat</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">condition</span>, y<span class="op">=</span><span class="va">thresh</span>,color<span class="op">=</span><span class="va">condition</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_jitter.html" class="external-link">geom_jitter</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">symbolid</span>, scale<span class="op">=</span><span class="st">'free_y'</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"DE Genes in Activated MAIT Cells"</span><span class="op">)</span>
<span class="va">ggbase</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_violin.html" class="external-link">geom_violin</a></span><span class="op">(</span><span class="op">)</span> </code></pre></div>
<p><img src="MAITAnalysis_files/figure-html/unnamed-chunk-4-1.png" width="768"></p>
<p>Here is a standard violin plot showing how expression differs in each gene between stimulated and unstimulated cells. What could be improved about this visualization to make it more accurately reflect the model that’s being fit?</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">flat_dat</span><span class="op">[</span>,<span class="va">lmPred</span><span class="op">:=</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">thresh</span><span class="op">~</span><span class="va">cngeneson</span> <span class="op">+</span> <span class="va">condition</span><span class="op">)</span><span class="op">$</span><span class="va">fitted</span>, key<span class="op">=</span><span class="va">symbolid</span><span class="op">]</span>
<span class="va">ggbase</span> <span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">cngeneson</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">lmPred</span><span class="op">)</span>, lty<span class="op">=</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">'Standardized Cellular Detection Rate'</span><span class="op">)</span></code></pre></div>
<p><img src="MAITAnalysis_files/figure-html/unnamed-chunk-5-1.png" width="768"></p>
<p>Really we are doing an analysis of covariance (ANCOVA), where we ask if at each value of <code>cngeneson</code> if the stimulated cells differ from the unstimulated, in multiple module components. That is a little bit complicated to visualize, so we’ll settle for just showing what the ANCOVA looks like on the zero-inflated data. Adding these fitted values is easy with <code>data.table</code> on the melted data.</p>
</div>
<div class="section level4">
<h4 id="visualizing-both-components">Visualizing both components<a class="anchor" aria-label="anchor" href="#visualizing-both-components"></a>
</h4>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## This is all rather kludgy at the moment</span>
<span class="va">MM</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/model.matrix.html">model.matrix</a></span><span class="op">(</span><span class="op">~</span><span class="va">condition</span>,<span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/duplicated.html" class="external-link">unique</a></span><span class="op">(</span><span class="fu">colData</span><span class="op">(</span><span class="va">sca</span><span class="op">)</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"condition"</span><span class="op">)</span>,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">MM</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html" class="external-link">str_extract</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">MM</span><span class="op">)</span>, <span class="st">'Stim|Unstim'</span><span class="op">)</span>
<span class="va">predicted</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/NMF/man/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">zlmCond</span>,modelmatrix<span class="op">=</span><span class="va">MM</span><span class="op">)</span>

<span class="co">## Avert your eyes...</span>
<span class="va">predicted</span><span class="op">[</span>, <span class="va">primerid</span><span class="op">:=</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">primerid</span><span class="op">)</span><span class="op">]</span>
<span class="va">predicted_sig</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="fu">mcols</span><span class="op">(</span><span class="va">sca</span><span class="op">)</span>, <span class="va">predicted</span><span class="op">[</span><span class="va">primerid</span><span class="op"><a href="https://rdrr.io/pkg/BiocGenerics/man/match.html" class="external-link">%in%</a></span><span class="va">entrez_to_plot</span><span class="op">]</span>, by<span class="op">=</span><span class="st">'primerid'</span><span class="op">)</span>
<span class="va">predicted_sig</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="va">predicted_sig</span><span class="op">)</span>

<span class="co">## plot with inverse logit transformed x-axis</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">predicted_sig</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="../reference/invlogit.html">invlogit</a></span><span class="op">(</span><span class="va">etaD</span><span class="op">)</span>,y<span class="op">=</span><span class="va">muC</span>,xse<span class="op">=</span><span class="va">seD</span>,yse<span class="op">=</span><span class="va">seC</span>,col<span class="op">=</span><span class="va">sample</span><span class="op">)</span><span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">symbolid</span>,scales<span class="op">=</span><span class="st">"free_y"</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_linedraw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span><span class="st">"Proportion expression"</span><span class="op">)</span><span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span><span class="st">"Estimated Mean"</span><span class="op">)</span><span class="op">+</span>
    <span class="fu"><a href="../reference/stat_ell.html">stat_ell</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">etaD</span>,y<span class="op">=</span><span class="va">muC</span><span class="op">)</span>,level<span class="op">=</span><span class="fl">0.95</span>, invert<span class="op">=</span><span class="st">'x'</span><span class="op">)</span></code></pre></div>
<p><img src="MAITAnalysis_files/figure-html/unnamed-chunk-6-1.png" width="768"></p>
<p>Lastly, we can visualize how each component of the hurdle model is combined to yield a differential test by plotting the estimated coefficients (and standard errors) as a scatter plot. These confidence ellipses are drawn based on the <span class="math inline">\(\chi^2_2\)</span> distribution on the simultaneous test that either coefficient differs from zero. What do you notice about the relationship between the confidence interval on the proportion (x) and mean (y)?</p>
</div>
<div class="section level3">
<h3 id="heatmap-of-maits-based-on-most-differentially-expressed-genes">Heatmap of MAITs based on most differentially expressed genes<a class="anchor" aria-label="anchor" href="#heatmap-of-maits-based-on-most-differentially-expressed-genes"></a>
</h3>
<p>Here’s what the 50 most significantly differentially expressed(DE) genes look like.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mat_to_plot</span> <span class="op">&lt;-</span> <span class="fu">assay</span><span class="op">(</span><span class="va">sca</span><span class="op">[</span><span class="va">entrez_to_plot</span>,<span class="op">]</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">mat_to_plot</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">symbols_to_plot</span>
<span class="fu"><a href="https://rdrr.io/pkg/NMF/man/aheatmap.html" class="external-link">aheatmap</a></span><span class="op">(</span><span class="va">mat_to_plot</span>,annCol<span class="op">=</span><span class="fu">colData</span><span class="op">(</span><span class="va">sca</span><span class="op">)</span><span class="op">[</span>,<span class="st">"condition"</span><span class="op">]</span>,main<span class="op">=</span><span class="st">"DE genes"</span>,col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/grDevices/colorRamp.html" class="external-link">colorRampPalette</a></span><span class="op">(</span>colors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/RColorBrewer/man/ColorBrewer.html" class="external-link">brewer.pal</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">"PiYG"</span>,n<span class="op">=</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span><span class="op">(</span><span class="fl">20</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="MAITAnalysis_files/figure-html/unnamed-chunk-7-1.png" width="768"></p>
<p>Some of the activated MAITs have transcriptional profiles more similar to unactivated MAITS.</p>
<div class="section level4">
<h4 id="exercises-on-hurdle-model-differential-expression">Exercises on hurdle model differential expression<a class="anchor" aria-label="anchor" href="#exercises-on-hurdle-model-differential-expression"></a>
</h4>
<ol start="3" style="list-style-type: decimal">
<li>In some of the libraries it was possible to recover portions of the T-cell receptor alpha and beta chains from the reads. Behold, we live a golden age:</li>
</ol>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/table.html" class="external-link">table</a></span><span class="op">(</span><span class="fu">colData</span><span class="op">(</span><span class="va">sca</span><span class="op">)</span><span class="op">$</span><span class="va">beta</span>, exclude<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## </span>
<span class="co">##  other TRBV20  TRBV4  TRBV6   &lt;NA&gt; </span>
<span class="co">##      9      5      4     18     37</span></code></pre>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#Note that we currently throw an uninformative error if a covariate is `NA`</span>
<span class="va">scaHasBeta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/subset.data.table.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">sca</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">beta</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>How could you test for differential expression between TCR <code>beta</code> subtypes among <code>scaHasBeta</code>, the cells in which the TCR was successfully inferred? What is worrying about this procedure?</p>
</div>
</div>
<div class="section level3">
<h3 id="residuals">Residuals<a class="anchor" aria-label="anchor" href="#residuals"></a>
</h3>
<p>In the MAST paper, we assessed this further by examining a <em>residual</em> from the Hurdle linear model. This is not an entirely well-defined concept, as there are really two residuals in the Hurdle model, and there are multiple forms of residual that one can consider in logistic regression. Nonetheless, it can be a useful diagnostic. You can get a form of residual by supplying a “hook” function to be called after each regression.</p>
<p>For example, in the subset of differentially expressed genes, we can refit the model and pull out the residual.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">scaDE</span> <span class="op">&lt;-</span> <span class="va">sca</span><span class="op">[</span><span class="va">entrez_to_plot</span>,<span class="op">]</span>
<span class="va">zlmResidDE</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/zlm.html">zlm</a></span><span class="op">(</span><span class="op">~</span><span class="va">condition</span> <span class="op">+</span> <span class="va">cngeneson</span>, <span class="va">scaDE</span>, hook<span class="op">=</span><span class="va">combined_residuals_hook</span><span class="op">)</span>
<span class="va">residDE</span> <span class="op">&lt;-</span> <span class="va">zlmResidDE</span><span class="op">@</span><span class="va">hookOut</span>
<span class="va">residDEMatrix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">residDE</span><span class="op">)</span></code></pre></div>
<p>The <code>residDE</code> was a list of residuals (one per gene in <code>scaDE</code>). We concatenated them into a matrix.</p>
<p>Now we can add <code>residDEMatrix</code> as another component of the “assay”:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">assays</span><span class="op">(</span><span class="va">scaDE</span>, withDimnames <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu">assays</span><span class="op">(</span><span class="va">scaDE</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>resid<span class="op">=</span><span class="va">residDEMatrix</span><span class="op">)</span><span class="op">)</span>
<span class="va">scaResidFlat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/methods/as.html" class="external-link">as</a></span><span class="op">(</span><span class="va">scaDE</span>, <span class="st">'data.table'</span><span class="op">)</span>
<span class="va">scaResidFlat</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>,<span class="op">]</span></code></pre></div>
<pre><code><span class="co">##    primerid entrez symbolid             wellKey condition nGeneOn  libSize</span>
<span class="co">## 1:     7295   7295      TXN 1-MAIT-Stim-C05_S91      Stim    8805 10055037</span>
<span class="co">## 2:     3002   3002     GZMB 1-MAIT-Stim-C05_S91      Stim    8805 10055037</span>
<span class="co">## 3:     1843   1843    DUSP1 1-MAIT-Stim-C05_S91      Stim    8805 10055037</span>
<span class="co">## 4:     1831   1831  TSC22D3 1-MAIT-Stim-C05_S91      Stim    8805 10055037</span>
<span class="co">##    PercentToHuman MedianCVCoverage PCRDuplicate exonRate pastFastqc ncells</span>
<span class="co">## 1:          0.896          0.93833     0.756202    0.651       PASS      1</span>
<span class="co">## 2:          0.896          0.93833     0.756202    0.651       PASS      1</span>
<span class="co">## 3:          0.896          0.93833     0.756202    0.651       PASS      1</span>
<span class="co">## 4:          0.896          0.93833     0.756202    0.651       PASS      1</span>
<span class="co">##     ngeneson cngeneson    TRAV1 TRBV6 TRBV4 TRBV20 alpha beta         ac   bc</span>
<span class="co">## 1: 0.2764538 0.9383393 10.39006     0     0      0 TRAV1 &lt;NA&gt; TRAV1.Stim &lt;NA&gt;</span>
<span class="co">## 2: 0.2764538 0.9383393 10.39006     0     0      0 TRAV1 &lt;NA&gt; TRAV1.Stim &lt;NA&gt;</span>
<span class="co">## 3: 0.2764538 0.9383393 10.39006     0     0      0 TRAV1 &lt;NA&gt; TRAV1.Stim &lt;NA&gt;</span>
<span class="co">## 4: 0.2764538 0.9383393 10.39006     0     0      0 TRAV1 &lt;NA&gt; TRAV1.Stim &lt;NA&gt;</span>
<span class="co">##    ourfilter   thresh        tpm      resid</span>
<span class="co">## 1:      TRUE 10.57847 10.5784670  0.2675493</span>
<span class="co">## 2:      TRUE 15.56626 15.5662625  3.7036990</span>
<span class="co">## 3:      TRUE  0.00000  0.1890338 -0.2414111</span>
<span class="co">## 4:      TRUE  0.00000  0.6415460 -0.5861746</span></code></pre>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">scaResidFlat</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">ngeneson</span>, y<span class="op">=</span><span class="va">resid</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>col<span class="op">=</span><span class="va">condition</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html" class="external-link">geom_smooth</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">symbolid</span><span class="op">)</span></code></pre></div>
<p><img src="MAITAnalysis_files/figure-html/addResiduals-1.png" width="576"></p>
<p>This allows us, for example, to evaluate model diagnostics such as this “residuals vs variable” plot to check the linearity assumption of “ngeneson”. One can also conduct PCA or examine the correlation matrix to look for co-expressing modules of genes.</p>
</div>
</div>
<div class="section level2">
<h2 id="gene-set-enrichment-analysis">Gene Set Enrichment Analysis<a class="anchor" aria-label="anchor" href="#gene-set-enrichment-analysis"></a>
</h2>
<p>We use a competitive gene set enrichment test, in which a contrast (hurdle model coefficient) from various gene sets of interest is compared to the background, accounting for the intergene correlation of the module coefficient.</p>
<p>To estimate the intergene correlation of the contrast, we use bootstrapping. Cells (columns in <code>sca</code>) are sampled with replacement a number of times and we refit the model. At some point, we may implement a GEE-like method to estimate the intergene correlation through asymptotic calculations. But in the meantime, the bootstrapping can be slow, although is pleasingly parallelizable. To avoid setting the server farm alight, we will work with only a subset of the genes, and only calculate 5 bootstrap replicates. This would be completely inadequate if you wanted to report these results.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># bootstrap, resampling cells</span>
<span class="co"># R should be set to &gt;50 if you were doing this for real.</span>
<span class="va">boots</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bootVcov1.html">bootVcov1</a></span><span class="op">(</span><span class="va">zlmCond</span>, R <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">module</span> <span class="op">&lt;-</span> <span class="st">"BTM"</span>
<span class="va">min_gene_in_module</span> <span class="op">&lt;-</span> <span class="fl">5</span>
<span class="va">packageExt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, package<span class="op">=</span><span class="st">'MAST'</span><span class="op">)</span>
<span class="va">module_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">packageExt</span>, pattern <span class="op">=</span> <span class="va">module</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="va">gene_set</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/GSEABase/man/getObjects.html" class="external-link">getGmt</a></span><span class="op">(</span><span class="va">module_file</span><span class="op">)</span>
<span class="va">gene_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/GSEABase/man/GeneSet-class.html" class="external-link">geneIds</a></span><span class="op">(</span><span class="va">gene_set</span><span class="op">)</span>
<span class="va">gene_ids</span> <span class="op">&lt;-</span> <span class="va">gene_ids</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">gene_ids</span><span class="op">)</span><span class="op"><a href="https://Rdatatable.gitlab.io/data.table/reference/like.html" class="external-link">%like%</a></span><span class="st">"TBA"</span><span class="op">&amp;</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">gene_ids</span><span class="op">)</span><span class="op"><a href="https://Rdatatable.gitlab.io/data.table/reference/like.html" class="external-link">%like%</a></span><span class="st">"B cell"</span><span class="op">]</span>
<span class="va">sets_indices</span> <span class="op">&lt;-</span> <span class="fu">limma</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/limma/man/ids2indices.html" class="external-link">ids2indices</a></span><span class="op">(</span><span class="va">gene_ids</span>, <span class="fu">mcols</span><span class="op">(</span><span class="va">sca</span><span class="op">)</span><span class="op">$</span><span class="va">symbolid</span><span class="op">)</span>
<span class="co"># Only keep modules with at least min_gene_in_module</span>
<span class="va">sets_indices</span> <span class="op">&lt;-</span> <span class="va">sets_indices</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">sets_indices</span>, <span class="va">length</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="va">min_gene_in_module</span><span class="op">]</span></code></pre></div>
<p>We will use the Blood Transcriptional Modules of <a href="www.nature.com/ni/journal/v15/n2/full/ni.2789.html">Li, et al</a> and select named modules not relating to B-cell functionality.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">gsea</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gseaAfterBoot.html">gseaAfterBoot</a></span><span class="op">(</span><span class="va">zlmCond</span>, <span class="va">boots</span>, <span class="va">sets_indices</span>, <span class="fu"><a href="../reference/Hypothesis.html">CoefficientHypothesis</a></span><span class="op">(</span><span class="st">"conditionStim"</span><span class="op">)</span><span class="op">)</span> 
<span class="va">z_stat_comb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/NMF/man/assess.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">gsea</span>, testType<span class="op">=</span><span class="st">'normal'</span><span class="op">)</span></code></pre></div>
<p>The <code>summary</code> method returns a <code>data.table</code> with columns giving discrete and continuous Z-scores (<code>disc_Z</code> and <code>cont_Z</code>) and P-values testing if the average coefficient in the gene set differs from the average coefficient outside the set. A combined P-value (using Stouffer’s method) is given in column <code>combined_P</code>. The effect sizes (difference in average regression coefficients) is given in <code>effect_disc</code> and <code>effect_cont</code>. For the discrete component this gives, for example, the difference in the average odds of expression in the set vs outside the set.</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sigModules</span> <span class="op">&lt;-</span> <span class="va">z_stat_comb</span><span class="op">[</span><span class="va">combined_adj</span><span class="op">&lt;</span><span class="fl">.01</span><span class="op">]</span>
<span class="va">gseaTable</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html" class="external-link">melt</a></span><span class="op">(</span><span class="va">sigModules</span><span class="op">[</span>,<span class="fu">.</span><span class="op">(</span><span class="va">set</span>, <span class="va">disc_Z</span>, <span class="va">cont_Z</span>, <span class="va">combined_Z</span><span class="op">)</span><span class="op">]</span>, id.vars<span class="op">=</span><span class="st">'set'</span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">gseaTable</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">set</span>, x<span class="op">=</span><span class="va">variable</span>, fill<span class="op">=</span><span class="va">value</span><span class="op">)</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_raster</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_fill_distiller</a></span><span class="op">(</span>palette<span class="op">=</span><span class="st">"PiYG"</span><span class="op">)</span></code></pre></div>
<p><img src="MAITAnalysis_files/figure-html/gseaView-1.png" width="768"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Andrew McDavid, Greg Finak, Masanao Yajima.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
